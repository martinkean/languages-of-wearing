<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#6366F1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Language of Wearing">

  <!-- SEO and Description -->
  <meta name="description" content="Collect and analyze clothing experiences through interactive forms">
  <meta name="keywords" content="fashion, clothing, experience, survey, analytics">

  <title>The Languages of Wearing</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="favicon.svg">

  <!-- External Stylesheet -->
  <link rel="stylesheet" href="stylesheet.css">

  <!-- Google Fonts - Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Supabase JavaScript Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Supabase Configuration -->
  <script src="config.js"></script>

  <!-- D3.js for Sunburst Charts -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<body>
  <!-- Main Application Container -->
  <div id="app">
    <!-- Header Section -->
    <header class="app-header">
      <h1 class="app-title">The Languages of Wearing</h1>
      <p class="app-subtitle">Share your clothing experiences and help us understand fashion better</p>
    </header>

    <!-- Navigation for Admin Toggle -->
    <nav class="app-nav">
      <button id="toggleViewBtn" class="toggle-button" aria-label="Switch between user and admin view">
        View Responses
      </button>
    </nav>

    <!-- User Form View -->
    <main id="userView" class="main-content">
      <section class="form-section">
        <form id="clothingForm" class="clothing-form" novalidate>
          <!-- Question 1: Physical Feeling -->
          <article class="question-container">
            <label for="physicalFeeling" class="question-label">
              How would you describe the physical feeling of the fashion as you are wearing it?
            </label>
            <textarea id="physicalFeeling" name="physicalFeeling" class="text-area-input" rows="4"
              placeholder="Describe how the clothing feels on your body..." required
              aria-describedby="physicalFeeling-error"></textarea>
            <span id="physicalFeeling-error" class="error-message" role="alert"></span>
          </article>

          <!-- Question 2: Material Quality (Radio Buttons) -->
          <article class="question-container">
            <fieldset class="radio-fieldset">
              <legend class="question-label">
                How would you describe the material the fashion is made of as you wear it?
              </legend>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" name="materialQuality" value="Great" class="radio-input" required>
                  <span class="radio-custom"></span>
                  Great
                </label>
                <label class="radio-label">
                  <input type="radio" name="materialQuality" value="Okay" class="radio-input" required>
                  <span class="radio-custom"></span>
                  Okay
                </label>
                <label class="radio-label">
                  <input type="radio" name="materialQuality" value="Not great" class="radio-input" required>
                  <span class="radio-custom"></span>
                  Not great
                </label>
              </div>
              <span id="materialQuality-error" class="error-message" role="alert"></span>
            </fieldset>
          </article>

          <!-- Question 3: Emotional Feeling -->
          <article class="question-container">
            <label for="emotionalFeeling" class="question-label">
              How does the fashion you tried on make you feel?
            </label>
            <textarea id="emotionalFeeling" name="emotionalFeeling" class="text-area-input" rows="4"
              placeholder="Describe your emotional response to wearing this item..." required
              aria-describedby="emotionalFeeling-error"></textarea>
            <span id="emotionalFeeling-error" class="error-message" role="alert"></span>
          </article>

          <!-- Question 4: Favorite Item -->
          <article class="question-container">
            <label for="favoriteItem" class="question-label">
              What is your favourite item of fashion?
            </label>
            <input type="text" id="favoriteItem" name="favoriteItem" class="text-input"
              placeholder="e.g., vintage denim jacket, silk scarf, leather boots..." required
              aria-describedby="favoriteItem-error">
            <span id="favoriteItem-error" class="error-message" role="alert"></span>
          </article>

          <!-- Question 5: Favorite Reason -->
          <article class="question-container">
            <label for="favoriteReason" class="question-label">
              Why is it your favourite?
            </label>
            <textarea id="favoriteReason" name="favoriteReason" class="text-area-input" rows="3"
              placeholder="Explain what makes this item special to you..." required
              aria-describedby="favoriteReason-error"></textarea>
            <span id="favoriteReason-error" class="error-message" role="alert"></span>
          </article>

          <!-- Submit Section -->
          <section class="submit-section">
            <button type="submit" id="submitBtn" class="submit-button">
              <span class="button-text">Submit Response</span>
              <span class="button-loader hidden" aria-hidden="true"></span>
            </button>
          </section>
        </form>

        <!-- Success/Error Messages -->
        <div id="messageContainer" class="message-container hidden">
          <div id="successMessage" class="success-message hidden" role="status">
            <strong>Thank you!</strong> Your response has been submitted successfully.
          </div>
          <div id="errorMessage" class="error-message-global hidden" role="alert">
            <strong>Error:</strong> <span id="errorText">Something went wrong. Please try again.</span>
          </div>
        </div>
      </section>
    </main>

    <!-- Login Screen -->
    <main id="loginView" class="main-content hidden">
      <section class="form-section">
        <h2 class="section-title">Login Required</h2>
        <p style="text-align: center; color: var(--color-gray-600); margin-bottom: var(--spacing-6);">
          Please enter your credentials to access the responses dashboard.
        </p>
        <form id="loginForm" class="clothing-form" style="max-width: 400px; margin: 0 auto;">
          <div class="question-container">
            <label for="loginUsername" class="question-label">Username</label>
            <input type="text" id="loginUsername" class="text-input" placeholder="Enter username" required
              autocomplete="username">
          </div>
          <div class="question-container">
            <label for="loginPassword" class="question-label">Password</label>
            <input type="password" id="loginPassword" class="text-input" placeholder="Enter password" required
              autocomplete="current-password">
          </div>
          <div class="submit-section">
            <button type="submit" class="submit-button">
              <span class="button-text">Login</span>
            </button>
          </div>
        </form>
        <div id="loginError" class="error-message-global hidden"
          style="max-width: 400px; margin: var(--spacing-4) auto 0;">
          <strong>Login Failed:</strong> <span id="loginErrorText">Invalid username or password.</span>
        </div>
      </section>
    </main>

    <!-- Responses Dashboard View -->
    <main id="adminView" class="main-content hidden">
      <section class="admin-section">
        <header class="admin-header">
          <h2 class="section-title">Responses Dashboard</h2>
          <div class="admin-controls">
            <button id="logoutBtn" class="control-button">
              Logout
            </button>
            <button id="refreshDataBtn" class="control-button">
              Refresh Data
            </button>
            <button id="exportDataBtn" class="control-button">
              Export CSV
            </button>
          </div>
        </header>

        <!-- Dashboard Navigation -->
        <nav class="dashboard-nav">
          <button id="showListViewBtn" class="nav-tab active" data-view="list">
            All Responses
          </button>
          <button id="showChartViewBtn" class="nav-tab" data-view="chart">
            Response Visualization
          </button>
        </nav>

        <!-- List View -->
        <section id="listView" class="dashboard-view">
          <div class="data-container">
            <div id="loadingIndicator" class="loading-indicator">
              Loading responses...
            </div>
            <div id="noDataMessage" class="no-data-message hidden">
              No responses found. Submit some responses first!
            </div>
            <div id="responsesList" class="responses-list hidden"></div>
          </div>
        </section>

        <!-- Chart View -->
        <section id="chartView" class="dashboard-view hidden">
          <div class="chart-container">
            <h3 class="chart-title">Clothing Experience Wheel</h3>
            <div id="sunburstChart" class="chart-area" style="text-align: center;">
              <div id="sunburstContainer"></div>
            </div>
            <div id="chartLegend" class="chart-stats"></div>
          </div>
        </section>
      </section>
    </main>
  </div>

  <!-- JavaScript for Application Logic -->
  <script>
    // Application Configuration
    const CONFIG = {
      // Supabase credentials loaded from config.js
      SUPABASE_URL: window.SUPABASE_CONFIG?.SUPABASE_URL || '',
      SUPABASE_ANON_KEY: window.SUPABASE_CONFIG?.SUPABASE_ANON_KEY || '',
      TABLE_NAME: 'clothing_responses',
      LOGIN_CREDENTIALS: {
        username: 'moderator',
        password: 'thecatsatonthemat2025'
      }
    };

    // Validate configuration on app start
    function validateConfig() {
      if (!CONFIG.SUPABASE_URL || !CONFIG.SUPABASE_ANON_KEY) {
        console.error('Missing Supabase configuration. Please set environment variables.');

        // Show user-friendly error message
        const errorMessage = `
          <div style="
            background: #fee2e2;
            color: #dc2626;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem;
            border: 1px solid #fca5a5;
          ">
            <strong>Configuration Error:</strong> 
            Database connection not configured. Please contact the administrator.
          </div>
        `;

        document.getElementById('app').innerHTML = errorMessage + document.getElementById('app').innerHTML;
        return false;
      }
      return true;
    }

    // Global State Management
    const AppState = {
      currentView: 'user',
      isLoggedIn: false,
      responses: [],
      isLoading: false
    };

    // DOM Elements Cache
    const Elements = {
      // Views
      userView: document.getElementById('userView'),
      loginView: document.getElementById('loginView'),
      adminView: document.getElementById('adminView'),
      toggleViewBtn: document.getElementById('toggleViewBtn'),

      // Form
      clothingForm: document.getElementById('clothingForm'),
      submitBtn: document.getElementById('submitBtn'),
      messageContainer: document.getElementById('messageContainer'),
      successMessage: document.getElementById('successMessage'),
      errorMessage: document.getElementById('errorMessage'),
      errorText: document.getElementById('errorText'),

      // Login
      loginForm: document.getElementById('loginForm'),
      loginUsername: document.getElementById('loginUsername'),
      loginPassword: document.getElementById('loginPassword'),
      loginError: document.getElementById('loginError'),
      loginErrorText: document.getElementById('loginErrorText'),
      logoutBtn: document.getElementById('logoutBtn'),

      // Admin Dashboard
      refreshDataBtn: document.getElementById('refreshDataBtn'),
      exportDataBtn: document.getElementById('exportDataBtn'),
      showListViewBtn: document.getElementById('showListViewBtn'),
      showChartViewBtn: document.getElementById('showChartViewBtn'),
      listView: document.getElementById('listView'),
      chartView: document.getElementById('chartView'),
      responsesList: document.getElementById('responsesList'),
      loadingIndicator: document.getElementById('loadingIndicator'),
      noDataMessage: document.getElementById('noDataMessage'),
      sunburstContainer: document.getElementById('sunburstContainer'),
      chartLegend: document.getElementById('chartLegend')
    };

    // Utility Functions
    const Utils = {
      // Format date for display
      formatDate(dateString) {
        return new Date(dateString).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      },

      // Sanitize text for HTML display
      sanitizeText(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      },

      // Show loading state
      showLoading(element, text = 'Loading...') {
        element.innerHTML = `<div class="loading-indicator">${text}</div>`;
      },

      // Generate CSV from data
      generateCSV(data) {
        if (!data.length) return '';

        const headers = Object.keys(data[0]);
        const csvContent = [
          headers.join(','),
          ...data.map(row =>
            headers.map(header => {
              const value = row[header] || '';
              return `"${value.toString().replace(/"/g, '""')}"`;
            }).join(',')
          )
        ].join('\n');

        return csvContent;
      }
    };

    // Form Validation
    const FormValidator = {
      // Validate individual field
      validateField(field) {
        const value = field.value.trim();
        const fieldName = field.name;
        let isValid = true;
        let message = '';

        // Remove existing error state
        field.classList.remove('error');
        const errorElement = document.getElementById(`${fieldName}-error`);
        if (errorElement) {
          errorElement.textContent = '';
        }

        // Check required fields
        if (field.required && !value) {
          isValid = false;
          message = 'This field is required.';
        }

        // Specific validation for radio buttons
        if (field.type === 'radio' && fieldName === 'materialQuality') {
          const checkedRadio = document.querySelector('input[name="materialQuality"]:checked');
          if (!checkedRadio) {
            isValid = false;
            message = 'Please select a material quality rating.';
          }
        }

        // Text area minimum length
        if (field.tagName === 'TEXTAREA' && value && value.length < 10) {
          isValid = false;
          message = 'Please provide a more detailed response (at least 10 characters).';
        }

        // Show error if invalid
        if (!isValid) {
          field.classList.add('error');
          if (errorElement) {
            errorElement.textContent = message;
          }
        }

        return isValid;
      },

      // Validate entire form
      validateForm(form) {
        const fields = form.querySelectorAll('input[required], textarea[required]');
        let isFormValid = true;

        fields.forEach(field => {
          if (!this.validateField(field)) {
            isFormValid = false;
          }
        });

        // Special handling for radio button group
        const radioGroup = form.querySelector('input[name="materialQuality"]');
        if (radioGroup && !this.validateField(radioGroup)) {
          isFormValid = false;
        }

        return isFormValid;
      }
    };

    // Supabase Integration (Mock Implementation)
    const SupabaseClient = {
      supabase: null,

      // Initialize connection with real Supabase client
      init() {
        this.supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        console.log('Real Supabase client initialized');
        return this;
      },

      // Submit response to database
      async submitResponse(responseData) {
        try {
          const { data, error } = await this.supabase
            .from(CONFIG.TABLE_NAME)
            .insert([responseData])
            .select();

          if (error) {
            console.error('Supabase insert error:', error);
            return { data: null, error: error.message };
          }

          return { data: data[0], error: null };
        } catch (error) {
          console.error('Submit response error:', error);
          return { data: null, error: error.message };
        }
      },

      // Fetch all responses
      async getResponses() {
        try {
          const { data, error } = await this.supabase
            .from(CONFIG.TABLE_NAME)
            .select('*')
            .order('created_at', { ascending: false });

          if (error) {
            console.error('Supabase select error:', error);
            return { data: null, error: error.message };
          }

          return { data, error: null };
        } catch (error) {
          console.error('Get responses error:', error);
          return { data: null, error: error.message };
        }
      }
    };

    // UI State Management
    const UIManager = {
      // Check login status on load
      checkLoginStatus() {
        const loggedIn = sessionStorage.getItem('moderator_logged_in');
        AppState.isLoggedIn = loggedIn === 'true';
        return AppState.isLoggedIn;
      },

      // Handle login
      async handleLogin(username, password) {
        if (username === CONFIG.LOGIN_CREDENTIALS.username &&
          password === CONFIG.LOGIN_CREDENTIALS.password) {
          AppState.isLoggedIn = true;
          sessionStorage.setItem('moderator_logged_in', 'true');
          this.showAdminView();
          return true;
        }
        return false;
      },

      // Handle logout
      handleLogout() {
        AppState.isLoggedIn = false;
        sessionStorage.removeItem('moderator_logged_in');
        this.showUserView();
      },

      // Show user view
      showUserView() {
        Elements.userView.classList.remove('hidden');
        Elements.loginView.classList.add('hidden');
        Elements.adminView.classList.add('hidden');
        Elements.toggleViewBtn.textContent = 'View Responses';
        AppState.currentView = 'user';
      },

      // Show login view
      showLoginView() {
        Elements.userView.classList.add('hidden');
        Elements.loginView.classList.remove('hidden');
        Elements.adminView.classList.add('hidden');
        Elements.toggleViewBtn.textContent = 'Back to Form';
        AppState.currentView = 'login';
      },

      // Show admin view
      showAdminView() {
        Elements.userView.classList.add('hidden');
        Elements.loginView.classList.add('hidden');
        Elements.adminView.classList.remove('hidden');
        Elements.toggleViewBtn.textContent = 'Back to Form';
        AppState.currentView = 'admin';
        this.loadAdminData();
      },

      // Toggle between user and admin views
      toggleView() {
        if (AppState.currentView === 'user') {
          // Check if logged in
          if (this.checkLoginStatus()) {
            this.showAdminView();
          } else {
            this.showLoginView();
          }
        } else {
          this.showUserView();
        }
      },

      // Show success message
      showSuccess(message) {
        Elements.messageContainer.classList.remove('hidden');
        Elements.successMessage.classList.remove('hidden');
        Elements.errorMessage.classList.add('hidden');
        Elements.successMessage.querySelector('strong').nextSibling.textContent = ' ' + message;

        // Auto-hide after 5 seconds
        setTimeout(() => {
          Elements.messageContainer.classList.add('hidden');
        }, 5000);
      },

      // Show error message
      showError(message) {
        Elements.messageContainer.classList.remove('hidden');
        Elements.errorMessage.classList.remove('hidden');
        Elements.successMessage.classList.add('hidden');
        Elements.errorText.textContent = message;

        // Auto-hide after 7 seconds
        setTimeout(() => {
          Elements.messageContainer.classList.add('hidden');
        }, 7000);
      },

      // Set loading state for submit button
      setSubmitLoading(isLoading) {
        const buttonText = Elements.submitBtn.querySelector('.button-text');
        const buttonLoader = Elements.submitBtn.querySelector('.button-loader');

        if (isLoading) {
          Elements.submitBtn.disabled = true;
          Elements.submitBtn.classList.add('loading');
          buttonText.textContent = 'Submitting...';
          buttonLoader.classList.remove('hidden');
        } else {
          Elements.submitBtn.disabled = false;
          Elements.submitBtn.classList.remove('loading');
          buttonText.textContent = 'Submit Response';
          buttonLoader.classList.add('hidden');
        }
      },

      // Load admin dashboard data
      async loadAdminData() {
        Elements.loadingIndicator.classList.remove('hidden');
        Elements.noDataMessage.classList.add('hidden');
        Elements.responsesList.classList.add('hidden');

        const { data, error } = await SupabaseClient.getResponses();

        Elements.loadingIndicator.classList.add('hidden');

        if (error) {
          this.showError('Failed to load responses: ' + error);
          return;
        }

        AppState.responses = data || [];

        if (AppState.responses.length === 0) {
          Elements.noDataMessage.classList.remove('hidden');
        } else {
          this.renderResponsesList();
          this.renderSunburstChart();
        }
      },

      // Render responses list
      renderResponsesList() {
        const html = AppState.responses.map((response, index) => `
          <article class="response-card">
            <header class="response-header">
              <h4 class="response-title">Response #${AppState.responses.length - index}</h4>
              <time class="response-date">${Utils.formatDate(response.created_at)}</time>
            </header>
            <div class="response-content">
              <div class="response-item">
                <strong>Physical Feeling:</strong>
                <p>${Utils.sanitizeText(response.physical_feeling)}</p>
              </div>
              <div class="response-item">
                <strong>Material Quality:</strong>
                <span class="material-badge material-${response.material_quality.toLowerCase().replace(' ', '-')}">${response.material_quality}</span>
              </div>
              <div class="response-item">
                <strong>Emotional Feeling:</strong>
                <p>${Utils.sanitizeText(response.emotional_feeling)}</p>
              </div>
              <div class="response-item">
                <strong>Favorite Item:</strong>
                <p>${Utils.sanitizeText(response.favorite_item)}</p>
              </div>
              <div class="response-item">
                <strong>Favorite Reason:</strong>
                <p>${Utils.sanitizeText(response.favorite_reason)}</p>
              </div>
            </div>
          </article>
        `).join('');

        Elements.responsesList.innerHTML = html;
        Elements.responsesList.classList.remove('hidden');
      },

      // Render sunburst chart using D3.js
      renderSunburstChart() {
        if (!window.d3 || AppState.responses.length === 0) {
          Elements.sunburstContainer.innerHTML = '<p style="text-align: center; padding: 2rem;">No data available for visualization</p>';
          return;
        }

        // Clear previous chart
        Elements.sunburstContainer.innerHTML = '';

        // Process data for sunburst
        const sunburstData = this.processSunburstData();

        // Create D3 sunburst
        this.createD3Sunburst(sunburstData);
      },

      // Process response data into sunburst structure
      processSunburstData() {
        const responses = AppState.responses;

        // Create hierarchical data structure
        const root = {
          name: "Clothing Experiences",
          children: [
            {
              name: "FEEL",
              children: [
                {
                  name: "Physical",
                  children: this.categorizeTextResponses(responses.map(r => r.physical_feeling), 'physical')
                },
                {
                  name: "Emotional",
                  children: this.categorizeTextResponses(responses.map(r => r.emotional_feeling), 'emotional')
                }
              ]
            },
            {
              name: "MATERIAL",
              children: [
                { name: "Great", value: responses.filter(r => r.material_quality === 'Great').length },
                { name: "Okay", value: responses.filter(r => r.material_quality === 'Okay').length },
                { name: "Not great", value: responses.filter(r => r.material_quality === 'Not great').length }
              ]
            },
            {
              name: "FAVOURITE",
              children: [
                {
                  name: "Items",
                  children: this.categorizeTextResponses(responses.map(r => r.favorite_item), 'items')
                },
                {
                  name: "Reasons",
                  children: this.categorizeTextResponses(responses.map(r => r.favorite_reason), 'reasons')
                }
              ]
            }
          ]
        };

        return root;
      },

      // Categorize text responses into groups
      categorizeTextResponses(responses, type) {
        const categories = {};

        responses.forEach(response => {
          if (!response) return;

          // Simple keyword-based categorization
          let category = 'Other';
          const text = response.toLowerCase();

          if (type === 'physical') {
            if (text.includes('comfort') || text.includes('soft') || text.includes('cozy')) category = 'Comfortable';
            else if (text.includes('rough') || text.includes('scratchy') || text.includes('irritating')) category = 'Uncomfortable';
            else if (text.includes('warm') || text.includes('hot')) category = 'Warm';
            else if (text.includes('cool') || text.includes('cold') || text.includes('breathable')) category = 'Cool';
            else if (text.includes('tight') || text.includes('loose') || text.includes('fit')) category = 'Fit';
          } else if (type === 'emotional') {
            if (text.includes('confident') || text.includes('powerful') || text.includes('strong')) category = 'Confident';
            else if (text.includes('happy') || text.includes('joy') || text.includes('good')) category = 'Happy';
            else if (text.includes('comfortable') || text.includes('relaxed') || text.includes('calm')) category = 'Relaxed';
            else if (text.includes('stylish') || text.includes('fashionable') || text.includes('trendy')) category = 'Stylish';
            else if (text.includes('beautiful') || text.includes('pretty') || text.includes('attractive')) category = 'Beautiful';
          } else if (type === 'items') {
            if (text.includes('shirt') || text.includes('top') || text.includes('blouse')) category = 'Tops';
            else if (text.includes('pants') || text.includes('jeans') || text.includes('trousers')) category = 'Bottoms';
            else if (text.includes('dress') || text.includes('skirt')) category = 'Dresses';
            else if (text.includes('jacket') || text.includes('coat') || text.includes('blazer')) category = 'Outerwear';
            else if (text.includes('shoe') || text.includes('boot') || text.includes('sneaker')) category = 'Footwear';
            else if (text.includes('hat') || text.includes('scarf') || text.includes('jewelry')) category = 'Accessories';
          } else if (type === 'reasons') {
            if (text.includes('comfort') || text.includes('comfortable')) category = 'Comfort';
            else if (text.includes('style') || text.includes('fashionable') || text.includes('looks')) category = 'Style';
            else if (text.includes('versatile') || text.includes('matches') || text.includes('goes with')) category = 'Versatile';
            else if (text.includes('quality') || text.includes('durable') || text.includes('lasts')) category = 'Quality';
            else if (text.includes('memory') || text.includes('sentimental') || text.includes('special')) category = 'Sentimental';
          }

          categories[category] = (categories[category] || 0) + 1;
        });

        return Object.entries(categories).map(([name, value]) => ({ name, value }));
      },

      // Create D3.js sunburst chart
      createD3Sunburst(data) {
        const width = 600;
        const height = 600;
        const radius = Math.min(width, height) / 2;

        // Color scale
        const color = d3.scaleOrdinal()
          .domain(['FEEL', 'MATERIAL', 'FAVOURITE'])
          .range(['#60a5fa', '#f87171', '#34d399']);

        // Create SVG
        const svg = d3.select(Elements.sunburstContainer)
          .append('svg')
          .attr('width', width)
          .attr('height', height)
          .style('font', '12px sans-serif');

        const g = svg.append('g')
          .attr('transform', `translate(${width / 2},${height / 2})`);

        // Create hierarchy
        const root = d3.hierarchy(data)
          .sum(d => d.value)
          .sort((a, b) => b.value - a.value);

        // Create partition layout
        const partition = d3.partition()
          .size([2 * Math.PI, radius]);

        partition(root);

        // Create arc generator
        const arc = d3.arc()
          .startAngle(d => d.x0)
          .endAngle(d => d.x1)
          .innerRadius(d => d.y0)
          .outerRadius(d => d.y1);

        // Add paths
        g.selectAll('path')
          .data(root.descendants())
          .join('path')
          .attr('d', arc)
          .attr('fill', d => {
            if (d.depth === 0) return '#ffffff';
            if (d.depth === 1) return color(d.data.name);
            return d3.color(color(d.ancestors()[1].data.name)).darker(d.depth - 1);
          })
          .attr('stroke', '#ffffff')
          .attr('stroke-width', 2)
          .style('cursor', 'pointer')
          .on('mouseover', function (event, d) {
            if (d.depth > 0) {
              d3.select(this).attr('opacity', 0.8);

              // Show tooltip
              const tooltip = g.append('text')
                .attr('class', 'tooltip')
                .attr('text-anchor', 'middle')
                .attr('y', -10)
                .style('font-weight', 'bold')
                .style('font-size', '14px')
                .text(d.data.name);

              if (d.data.value) {
                g.append('text')
                  .attr('class', 'tooltip')
                  .attr('text-anchor', 'middle')
                  .attr('y', 10)
                  .style('font-size', '12px')
                  .text(`Count: ${d.data.value}`);
              }
            }
          })
          .on('mouseout', function (event, d) {
            d3.select(this).attr('opacity', 1);
            g.selectAll('.tooltip').remove();
          });

        // Add center text
        g.append('text')
          .attr('text-anchor', 'middle')
          .attr('y', -10)
          .style('font-size', '16px')
          .style('font-weight', 'bold')
          .text('CLOTHING');

        g.append('text')
          .attr('text-anchor', 'middle')
          .attr('y', 10)
          .style('font-size', '16px')
          .style('font-weight', 'bold')
          .text('EXPERIENCES');

        // Add legend
        const legendData = [
          { name: 'FEEL', color: '#60a5fa' },
          { name: 'MATERIAL', color: '#f87171' },
          { name: 'FAVOURITE', color: '#34d399' }
        ];

        const legend = Elements.chartLegend;
        legend.innerHTML = legendData.map(item => `
          <div class="stat-item">
            <span class="stat-label" style="display: flex; align-items: center;">
              <span style="width: 16px; height: 16px; background: ${item.color}; border-radius: 3px; margin-right: 8px;"></span>
              ${item.name}
            </span>
            <span class="stat-value">${root.children.find(child => child.data.name === item.name)?.value || 0}</span>
          </div>
        `).join('');
      },

      // Switch dashboard views
      switchDashboardView(view) {
        // Update nav tabs
        document.querySelectorAll('.nav-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        document.querySelector(`[data-view="${view}"]`).classList.add('active');

        // Show appropriate view
        Elements.listView.classList.toggle('hidden', view !== 'list');
        Elements.chartView.classList.toggle('hidden', view !== 'chart');
      },

      // Export data as CSV
      exportData() {
        if (AppState.responses.length === 0) {
          this.showError('No data to export');
          return;
        }

        const csvData = Utils.generateCSV(AppState.responses);
        const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');

        if (link.download !== undefined) {
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', `clothing-responses-${new Date().toISOString().split('T')[0]}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }
    };

    // Form Handler
    const FormHandler = {
      // Handle login form submission
      async handleLogin(event) {
        event.preventDefault();

        const username = Elements.loginUsername.value.trim();
        const password = Elements.loginPassword.value;

        const success = await UIManager.handleLogin(username, password);

        if (success) {
          Elements.loginForm.reset();
          Elements.loginError.classList.add('hidden');
        } else {
          Elements.loginError.classList.remove('hidden');
          Elements.loginPassword.value = '';
          Elements.loginUsername.focus();
        }
      },

      // Handle form submission
      async handleSubmit(event) {
        event.preventDefault();

        const form = event.target;

        // Validate form
        if (!FormValidator.validateForm(form)) {
          return;
        }

        // Prepare form data
        const formData = new FormData(form);
        const responseData = {
          physical_feeling: formData.get('physicalFeeling').trim(),
          material_quality: formData.get('materialQuality'),
          emotional_feeling: formData.get('emotionalFeeling').trim(),
          favorite_item: formData.get('favoriteItem').trim(),
          favorite_reason: formData.get('favoriteReason').trim()
        };

        // Show loading state
        UIManager.setSubmitLoading(true);

        // Submit to database
        const { data, error } = await SupabaseClient.submitResponse(responseData);

        // Hide loading state
        UIManager.setSubmitLoading(false);

        if (error) {
          UIManager.showError('Failed to submit response. Please try again.');
          return;
        }

        // Show success and reset form
        UIManager.showSuccess('Your response has been submitted successfully!');
        form.reset();

        // Remove any error states
        form.querySelectorAll('.error').forEach(field => {
          field.classList.remove('error');
        });
        form.querySelectorAll('.error-message').forEach(error => {
          error.textContent = '';
        });
      }
    };

    // Event Listeners
    function initEventListeners() {
      // Form submission
      Elements.clothingForm.addEventListener('submit', FormHandler.handleSubmit);

      // Login form submission
      Elements.loginForm.addEventListener('submit', FormHandler.handleLogin);

      // Field validation on blur
      Elements.clothingForm.addEventListener('blur', (event) => {
        if (event.target.matches('input, textarea')) {
          FormValidator.validateField(event.target);
        }
      }, true);

      // View toggle
      Elements.toggleViewBtn.addEventListener('click', UIManager.toggleView.bind(UIManager));

      // Logout button
      Elements.logoutBtn.addEventListener('click', UIManager.handleLogout.bind(UIManager));

      // Admin dashboard controls
      Elements.refreshDataBtn.addEventListener('click', UIManager.loadAdminData.bind(UIManager));
      Elements.exportDataBtn.addEventListener('click', UIManager.exportData.bind(UIManager));

      // Dashboard navigation
      Elements.showListViewBtn.addEventListener('click', () => UIManager.switchDashboardView('list'));
      Elements.showChartViewBtn.addEventListener('click', () => UIManager.switchDashboardView('chart'));
    }

    // PWA Service Worker Registration
    function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then((registration) => {
              console.log('SW registered: ', registration);
            })
            .catch((registrationError) => {
              console.log('SW registration failed: ', registrationError);
            });
        });
      }
    }

    // Application Initialization
    function initApp() {
      // Validate configuration first
      if (!validateConfig()) {
        console.log('App initialization stopped due to configuration errors');
        return;
      }

      // Initialize Supabase client
      SupabaseClient.init();

      // Set up event listeners
      initEventListeners();

      // Register service worker for PWA
      registerServiceWorker();

      // Check login status and URL parameters
      UIManager.checkLoginStatus();
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('admin') === 'true') {
        if (UIManager.checkLoginStatus()) {
          UIManager.showAdminView();
        } else {
          UIManager.showLoginView();
        }
      }

      console.log('The Language of Wearing app initialized');
    }

    // Start the application when DOM is loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }
  </script>
</body>

</html>