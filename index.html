<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Language of Wearing</title>

  <!-- PWA Configuration -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#6366f1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Language of Wearing">

  <!-- Favicon and Icons -->
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>👗</text></svg>">
  <link rel="apple-touch-icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%236366f1'/><text x='96' y='120' text-anchor='middle' font-size='96' fill='white'>👗</text></svg>">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- D3.js for sunburst chart -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <!-- Supabase JavaScript SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="stylesheet.css">

  <!-- Supabase Configuration -->
  <script src="config.js"></script>
</head>

<body>
  <div id="app">
    <!-- App Header -->
    <header class="app-header">
      <h1 class="app-title">The Language of Wearing</h1>
      <p class="app-subtitle">Share your clothing experiences and discover how fabric makes us feel</p>
    </header>

    <!-- Navigation -->
    <nav class="app-nav">
      <!-- PWA Install Buttons -->
      <button id="installButton" class="toggle-button" style="display: none;">
        📱 Install App
      </button>
      <button id="installIosButton" class="toggle-button" style="display: none;">
        📱 Install on iPhone
      </button>

      <!-- Online/Offline Status -->
      <div id="onlineStatus" class="online-status">
        <span id="statusIndicator" class="status-indicator">🟢</span>
        <span id="statusText">Online</span>
      </div>

      <!-- View Toggle -->
      <button id="toggleView" class="toggle-button">View Responses</button>
    </nav>

    <!-- Main Content -->
    <main id="mainContent" class="main-content">
      <!-- Clothing Experience Form -->
      <section id="formSection" class="form-section">
        <form id="clothingForm" class="clothing-form">
          <!-- Physical Feeling Question -->
          <div class="question-container">
            <label for="physicalFeeling" class="question-label">
              How does your clothing feel physically right now?
            </label>
            <textarea id="physicalFeeling" name="physicalFeeling" class="text-area-input"
              placeholder="Describe the physical sensations... comfortable, tight, soft, scratchy, etc." rows="4"
              required></textarea>
          </div>

          <!-- Material Quality Question -->
          <fieldset class="radio-fieldset">
            <legend class="question-label">
              How would you rate the material quality of what you're wearing?
            </legend>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="materialQuality" value="Great" class="radio-input" required>
                <span class="radio-text">Great</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="materialQuality" value="Okay" class="radio-input" required>
                <span class="radio-text">Okay</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="materialQuality" value="Not great" class="radio-input" required>
                <span class="radio-text">Not great</span>
              </label>
            </div>
          </fieldset>

          <!-- Emotional Feeling Question -->
          <div class="question-container">
            <label for="emotionalFeeling" class="question-label">
              How does your clothing make you feel emotionally?
            </label>
            <textarea id="emotionalFeeling" name="emotionalFeeling" class="text-area-input"
              placeholder="Describe your emotional response... confident, stylish, comfortable, self-conscious, etc."
              rows="4" required></textarea>
          </div>

          <!-- Favorite Item Question -->
          <div class="question-container">
            <label for="favoriteItem" class="question-label">
              What's your favorite item of clothing you're wearing today?
            </label>
            <input type="text" id="favoriteItem" name="favoriteItem" class="text-input"
              placeholder="e.g., my vintage denim jacket, comfortable sneakers, soft wool sweater..." required>
          </div>

          <!-- Favorite Reason Question -->
          <div class="question-container">
            <label for="favoriteReason" class="question-label">
              Why is this your favorite item?
            </label>
            <textarea id="favoriteReason" name="favoriteReason" class="text-area-input"
              placeholder="Explain what makes this item special to you..." rows="3" required></textarea>
          </div>

          <!-- Submit Section -->
          <div class="submit-section">
            <button type="submit" class="submit-button">
              <span class="button-text">Share Your Experience</span>
            </button>
          </div>
        </form>

        <!-- Success/Error Messages -->
        <div id="messageContainer" class="message-container hidden"></div>
      </section>
    </main>

    <!-- Login Modal -->
    <div id="loginModal" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Response Dashboard Access</h3>
          <button id="closeLoginModal" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="login-section">
            <form id="loginForm" class="login-form">
              <div class="question-container">
                <label for="username" class="question-label">Username</label>
                <input type="text" id="username" name="username" class="text-input" placeholder="Enter username"
                  required>
              </div>
              <div class="question-container">
                <label for="password" class="question-label">Password</label>
                <input type="password" id="password" name="password" class="text-input" placeholder="Enter password"
                  required>
              </div>
              <div class="submit-section">
                <button type="submit" class="submit-button">
                  <span class="button-text">Access Dashboard</span>
                </button>
              </div>
            </form>
            <div id="loginError" class="error-message-global hidden"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- iOS Install Modal -->
    <div id="iosInstallModal" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3>📱 Install on iPhone</h3>
          <button id="closeIosModal" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <p>To install this app on your iPhone:</p>
          <ol>
            <li>Tap the <strong class="share-icon">Share</strong> button at the bottom of Safari</li>
            <li>Scroll down and tap <strong>"Add to Home Screen"</strong></li>
            <li>Tap <strong>"Add"</strong> in the top right</li>
          </ol>
          <div class="install-benefits">
            <p><strong>Why install?</strong></p>
            <ul>
              <li>🚀 Faster loading and better performance</li>
              <li>📱 Works like a native app</li>
              <li>🔒 Works offline - never lose your data</li>
              <li>🏠 Easy access from your home screen</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Responses Dashboard -->
    <section id="responsesSection" class="admin-section hidden">
      <div class="admin-header">
        <h2 class="section-title">Response Dashboard</h2>
        <div class="admin-controls">
          <button id="refreshData" class="control-button">🔄 Refresh</button>
          <button id="exportData" class="control-button">📊 Export CSV</button>
          <button id="logoutButton" class="control-button">🚪 Logout</button>
        </div>
      </div>

      <!-- Dashboard Navigation -->
      <nav class="dashboard-nav">
        <button class="nav-tab active" data-tab="visualization">📈 Response Visualization</button>
        <button class="nav-tab" data-tab="responses">📝 All Responses</button>
      </nav>

      <!-- Visualization Tab -->
      <div id="visualizationTab" class="dashboard-view">
        <div id="loadingIndicator" class="loading-indicator">
          Loading response data...
        </div>
        <div id="noDataMessage" class="no-data-message hidden">
          No responses available yet. Share the form to start collecting data!
        </div>
        <div id="chartContainer" class="chart-container hidden">
          <h3 class="chart-title">Clothing Experience Insights</h3>
          <div class="chart-area">
            <div id="sunburstContainer"></div>
          </div>
        </div>
      </div>

      <!-- Responses Tab -->
      <div id="responsesTab" class="dashboard-view hidden">
        <div id="responsesLoadingIndicator" class="loading-indicator">
          Loading responses...
        </div>
        <div id="responsesNoDataMessage" class="no-data-message hidden">
          No responses to display yet.
        </div>
        <div id="dataContainer" class="data-container hidden">
          <div id="responsesList" class="responses-list"></div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // PWA Variables
    let deferredPrompt;
    let isInstalled = false;
    let isLoggedIn = false;
    let supabase;

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function () {
      initializeApp();
      setupPWA();
      setupAuth();
      setupNavigation();
      setupForms();
      setupOnlineOfflineHandling();
    });

    // Initialize Supabase and app
    function initializeApp() {
      // Initialize Supabase
      if (window.SUPABASE_CONFIG && window.supabase) {
        supabase = window.supabase.createClient(
          window.SUPABASE_CONFIG.SUPABASE_URL,
          window.SUPABASE_CONFIG.SUPABASE_ANON_KEY
        );
        console.log('Supabase initialized');
      } else {
        console.warn('Supabase not configured - using offline mode');
      }

      // Register service worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js')
          .then((registration) => {
            console.log('Service Worker registered:', registration);
          })
          .catch((error) => {
            console.error('Service Worker registration failed:', error);
          });
      }
    }

    // PWA Installation Setup
    function setupPWA() {
      const installButton = document.getElementById('installButton');
      const installIosButton = document.getElementById('installIosButton');
      const iosModal = document.getElementById('iosInstallModal');
      const closeIosModal = document.getElementById('closeIosModal');

      // Check if already installed
      if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
        isInstalled = true;
        return;
      }

      // Detect iOS
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isInStandaloneMode = ('standalone' in window.navigator) && (window.navigator.standalone);

      if (isIOS && !isInStandaloneMode) {
        // Show iOS install button
        installIosButton.style.display = 'inline-block';
        installIosButton.addEventListener('click', () => {
          iosModal.classList.remove('hidden');
        });
      } else {
        // Show regular install button for Android/Chrome
        installButton.style.display = 'inline-block';
      }

      // iOS modal close
      closeIosModal.addEventListener('click', () => {
        iosModal.classList.add('hidden');
      });

      // Click outside to close iOS modal
      iosModal.addEventListener('click', (e) => {
        if (e.target === iosModal) {
          iosModal.classList.add('hidden');
        }
      });

      // Listen for beforeinstallprompt event
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installButton.style.display = 'inline-block';
      });

      // Install button click handler
      installButton.addEventListener('click', async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          if (outcome === 'accepted') {
            installButton.style.display = 'none';
          }
          deferredPrompt = null;
        }
      });

      // Listen for app installed event
      window.addEventListener('appinstalled', () => {
        installButton.style.display = 'none';
        installIosButton.style.display = 'none';
        isInstalled = true;
        console.log('PWA installed successfully');
      });
    }

    // Online/Offline Status
    function setupOnlineOfflineHandling() {
      const statusIndicator = document.getElementById('statusIndicator');
      const statusText = document.getElementById('statusText');

      function updateOnlineStatus() {
        if (navigator.onLine) {
          statusIndicator.textContent = '🟢';
          statusIndicator.className = 'status-indicator online';
          statusText.textContent = 'Online';
          syncOfflineData();
        } else {
          statusIndicator.textContent = '🔴';
          statusIndicator.className = 'status-indicator offline';
          statusText.textContent = 'Offline';
        }
      }

      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);
      updateOnlineStatus();
    }

    // IndexedDB Setup for offline storage
    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('ClothingResponsesDB', 1);

        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);

        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('responses')) {
            const store = db.createObjectStore('responses', { keyPath: 'id', autoIncrement: true });
            store.createIndex('timestamp', 'timestamp', { unique: false });
          }
        };
      });
    }

    // Save response offline
    async function saveResponseOffline(responseData) {
      try {
        const db = await initDB();
        const transaction = db.transaction(['responses'], 'readwrite');
        const store = transaction.objectStore('responses');

        const dataToSave = {
          ...responseData,
          timestamp: new Date().toISOString(),
          synced: false
        };

        await store.add(dataToSave);
        console.log('Response saved offline');
        return true;
      } catch (error) {
        console.error('Error saving offline:', error);
        return false;
      }
    }

    // Sync offline data when online
    async function syncOfflineData() {
      if (!navigator.onLine || !supabase) return;

      try {
        const db = await initDB();
        const transaction = db.transaction(['responses'], 'readwrite');
        const store = transaction.objectStore('responses');
        const unsynced = await store.getAll();

        const toSync = unsynced.filter(item => !item.synced);
        if (toSync.length === 0) return;

        let syncedCount = 0;
        for (const response of toSync) {
          try {
            const { error } = await supabase
              .from('clothing_responses')
              .insert([{
                physical_feeling: response.physical_feeling,
                material_quality: response.material_quality,
                emotional_feeling: response.emotional_feeling,
                favorite_item: response.favorite_item,
                favorite_reason: response.favorite_reason
              }]);

            if (!error) {
              // Mark as synced
              response.synced = true;
              await store.put(response);
              syncedCount++;
            }
          } catch (error) {
            console.error('Error syncing individual response:', error);
          }
        }

        if (syncedCount > 0) {
          showMessage(`Synced ${syncedCount} offline response${syncedCount > 1 ? 's' : ''}!`, 'success');
        }
      } catch (error) {
        console.error('Error during sync:', error);
      }
    }

    // Authentication Setup
    function setupAuth() {
      isLoggedIn = sessionStorage.getItem('clothingAppAuth') === 'true';

      if (isLoggedIn) {
        showResponsesView();
      }
    }

    // Navigation Setup
    function setupNavigation() {
      const toggleView = document.getElementById('toggleView');
      const loginModal = document.getElementById('loginModal');
      const closeLoginModal = document.getElementById('closeLoginModal');
      const logoutButton = document.getElementById('logoutButton');

      toggleView.addEventListener('click', () => {
        if (isLoggedIn) {
          if (document.getElementById('responsesSection').classList.contains('hidden')) {
            showResponsesView();
          } else {
            showFormView();
          }
        } else {
          loginModal.classList.remove('hidden');
        }
      });

      closeLoginModal.addEventListener('click', () => {
        loginModal.classList.add('hidden');
      });

      loginModal.addEventListener('click', (e) => {
        if (e.target === loginModal) {
          loginModal.classList.add('hidden');
        }
      });

      logoutButton.addEventListener('click', () => {
        isLoggedIn = false;
        sessionStorage.removeItem('clothingAppAuth');
        showFormView();
      });

      // Dashboard navigation
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          switchDashboardTab(tab.dataset.tab);
        });
      });
    }

    // Form Setup
    function setupForms() {
      const clothingForm = document.getElementById('clothingForm');
      const loginForm = document.getElementById('loginForm');
      const refreshData = document.getElementById('refreshData');
      const exportData = document.getElementById('exportData');

      clothingForm.addEventListener('submit', handleFormSubmit);
      loginForm.addEventListener('submit', handleLogin);
      refreshData.addEventListener('click', loadResponseData);
      exportData.addEventListener('click', exportToCSV);
    }

    // Handle Form Submission
    async function handleFormSubmit(e) {
      e.preventDefault();

      const formData = new FormData(e.target);
      const responseData = {
        physical_feeling: formData.get('physicalFeeling'),
        material_quality: formData.get('materialQuality'),
        emotional_feeling: formData.get('emotionalFeeling'),
        favorite_item: formData.get('favoriteItem'),
        favorite_reason: formData.get('favoriteReason')
      };

      const submitButton = e.target.querySelector('.submit-button');
      const buttonText = submitButton.querySelector('.button-text');

      // Show loading state
      submitButton.disabled = true;
      submitButton.classList.add('loading');
      buttonText.innerHTML = '<span class="button-loader"></span> Submitting...';

      try {
        let success = false;

        // Try online submission first
        if (navigator.onLine && supabase) {
          const { error } = await supabase
            .from('clothing_responses')
            .insert([responseData]);

          success = !error;
          if (error) throw error;
        }

        // Save offline as backup or if online failed
        if (!success || !navigator.onLine) {
          success = await saveResponseOffline(responseData);
        }

        if (success) {
          showMessage(
            navigator.onLine
              ? 'Thank you! Your response has been submitted successfully.'
              : 'Response saved offline. It will sync when you\'re back online.',
            'success'
          );
          e.target.reset();
        } else {
          throw new Error('Failed to save response');
        }
      } catch (error) {
        console.error('Submission error:', error);

        // Try to save offline as last resort
        const offlineSaved = await saveResponseOffline(responseData);
        if (offlineSaved) {
          showMessage('Response saved offline. It will sync when connection is restored.', 'success');
          e.target.reset();
        } else {
          showMessage('Sorry, there was an error submitting your response. Please try again.', 'error');
        }
      } finally {
        // Reset button state
        submitButton.disabled = false;
        submitButton.classList.remove('loading');
        buttonText.textContent = 'Share Your Experience';
      }
    }

    // Handle Login
    async function handleLogin(e) {
      e.preventDefault();

      const formData = new FormData(e.target);
      const username = formData.get('username');
      const password = formData.get('password');

      const submitButton = e.target.querySelector('.submit-button');
      const buttonText = submitButton.querySelector('.button-text');
      const errorDiv = document.getElementById('loginError');

      // Show loading state
      submitButton.disabled = true;
      submitButton.classList.add('loading');
      buttonText.innerHTML = '<span class="button-loader"></span> Checking...';
      errorDiv.classList.add('hidden');

      try {
        // Simple credential check
        if (username === 'moderator' && password === 'thecatsatonthemat2025') {
          isLoggedIn = true;
          sessionStorage.setItem('clothingAppAuth', 'true');
          document.getElementById('loginModal').classList.add('hidden');
          showResponsesView();
          e.target.reset();
        } else {
          throw new Error('Invalid credentials');
        }
      } catch (error) {
        errorDiv.textContent = 'Invalid username or password. Please try again.';
        errorDiv.classList.remove('hidden');
      } finally {
        // Reset button state
        submitButton.disabled = false;
        submitButton.classList.remove('loading');
        buttonText.textContent = 'Access Dashboard';
      }
    }

    // Show/Hide Views
    function showFormView() {
      document.getElementById('formSection').classList.remove('hidden');
      document.getElementById('responsesSection').classList.add('hidden');
      document.getElementById('toggleView').textContent = 'View Responses';
    }

    function showResponsesView() {
      document.getElementById('formSection').classList.add('hidden');
      document.getElementById('responsesSection').classList.remove('hidden');
      document.getElementById('toggleView').textContent = 'Back to Form';
      loadResponseData();
    }

    // Dashboard Tab Switching
    function switchDashboardTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

      // Show/hide content
      document.getElementById('visualizationTab').classList.toggle('hidden', tabName !== 'visualization');
      document.getElementById('responsesTab').classList.toggle('hidden', tabName !== 'responses');

      // Load data for active tab
      if (tabName === 'visualization') {
        loadResponseData();
      } else if (tabName === 'responses') {
        loadAllResponses();
      }
    }

    // Load Response Data for Visualization
    async function loadResponseData() {
      if (!isLoggedIn) return;

      const loadingIndicator = document.getElementById('loadingIndicator');
      const noDataMessage = document.getElementById('noDataMessage');
      const chartContainer = document.getElementById('chartContainer');

      loadingIndicator.classList.remove('hidden');
      noDataMessage.classList.add('hidden');
      chartContainer.classList.add('hidden');

      try {
        let responses = [];

        if (supabase) {
          const { data, error } = await supabase
            .from('clothing_responses')
            .select('*')
            .order('created_at', { ascending: false });

          if (error) throw error;
          responses = data || [];
        }

        loadingIndicator.classList.add('hidden');

        if (responses.length === 0) {
          noDataMessage.classList.remove('hidden');
        } else {
          chartContainer.classList.remove('hidden');
          createD3Sunburst(responses);
        }
      } catch (error) {
        console.error('Error loading data:', error);
        loadingIndicator.classList.add('hidden');
        noDataMessage.classList.remove('hidden');
      }
    }

    // Load All Responses for List View
    async function loadAllResponses() {
      if (!isLoggedIn) return;

      const loadingIndicator = document.getElementById('responsesLoadingIndicator');
      const noDataMessage = document.getElementById('responsesNoDataMessage');
      const dataContainer = document.getElementById('dataContainer');

      loadingIndicator.classList.remove('hidden');
      noDataMessage.classList.add('hidden');
      dataContainer.classList.add('hidden');

      try {
        let responses = [];

        if (supabase) {
          const { data, error } = await supabase
            .from('clothing_responses')
            .select('*')
            .order('created_at', { ascending: false });

          if (error) throw error;
          responses = data || [];
        }

        loadingIndicator.classList.add('hidden');

        if (responses.length === 0) {
          noDataMessage.classList.remove('hidden');
        } else {
          dataContainer.classList.remove('hidden');
          displayResponses(responses);
        }
      } catch (error) {
        console.error('Error loading responses:', error);
        loadingIndicator.classList.add('hidden');
        noDataMessage.classList.remove('hidden');
      }
    }

    // Display Responses in List
    function displayResponses(responses) {
      const responsesList = document.getElementById('responsesList');
      responsesList.innerHTML = '';

      responses.forEach(response => {
        const responseCard = document.createElement('div');
        responseCard.className = 'response-card';

        const date = new Date(response.created_at).toLocaleString();

        responseCard.innerHTML = `
          <div class="response-header">
            <h3 class="response-title">Response #${response.id}</h3>
            <span class="response-date">${date}</span>
          </div>
          <div class="response-content">
            <div class="response-item">
              <strong>Physical Feeling:</strong>
              <p>${response.physical_feeling}</p>
            </div>
            <div class="response-item">
              <strong>Material Quality:</strong>
              <p><span class="material-badge material-${response.material_quality.toLowerCase().replace(' ', '-')}">${response.material_quality}</span></p>
            </div>
            <div class="response-item">
              <strong>Emotional Feeling:</strong>
              <p>${response.emotional_feeling}</p>
            </div>
            <div class="response-item">
              <strong>Favorite Item:</strong>
              <p>${response.favorite_item}</p>
            </div>
            <div class="response-item">
              <strong>Why Favorite:</strong>
              <p>${response.favorite_reason}</p>
            </div>
          </div>
        `;

        responsesList.appendChild(responseCard);
      });
    }

    // D3.js Sunburst Chart Creation
    function createD3Sunburst(responses) {
      // Clear previous chart
      d3.select("#sunburstContainer").selectAll("*").remove();

      // Color palette from oyster wheel
      const colors = {
        FEEL: ['#4a90e2', '#357abd', '#2c5aa0'],
        MATERIAL: ['#f5a623', '#e8931e', '#d07c18'],
        FAVOURITE: ['#7ed321', '#6bb71c', '#5a9b17']
      };

      // Process data into hierarchical structure
      const processedData = processResponsesForSunburst(responses);

      // Set dimensions
      const width = 600;
      const height = 600;
      const radius = Math.min(width, height) / 2;

      // Create SVG
      const svg = d3.select("#sunburstContainer")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", `translate(${width / 2},${height / 2})`);

      // Create partition layout
      const partition = d3.partition()
        .size([2 * Math.PI, radius]);

      // Create hierarchy
      const root = d3.hierarchy(processedData)
        .sum(d => d.value || 0);

      partition(root);

      // Create arcs
      const arc = d3.arc()
        .startAngle(d => d.x0)
        .endAngle(d => d.x1)
        .innerRadius(d => d.y0)
        .outerRadius(d => d.y1);

      // Color function
      const color = (d) => {
        if (d.depth === 0) return '#ffffff';
        if (d.depth === 1) {
          const sectionColors = colors[d.data.name] || ['#666666'];
          return sectionColors[0];
        }
        if (d.depth === 2) {
          const parent = d.parent.data.name;
          const sectionColors = colors[parent] || ['#666666'];
          const index = d.parent.children.indexOf(d) % sectionColors.length;
          return sectionColors[index];
        }
        if (d.depth === 3) {
          const grandparent = d.parent.parent.data.name;
          const sectionColors = colors[grandparent] || ['#666666'];
          const index = Math.floor(d.parent.children.indexOf(d) / 2) % sectionColors.length;
          return d3.color(sectionColors[index]).darker(0.3);
        }
        return '#cccccc';
      };

      // Draw arcs
      const path = svg.selectAll("path")
        .data(root.descendants())
        .enter().append("path")
        .attr("d", arc)
        .attr("fill", color)
        .attr("stroke", "#ffffff")
        .attr("stroke-width", 2);

      // Add text labels
      const text = svg.selectAll("text")
        .data(root.descendants().filter(d => d.depth > 0))
        .enter().append("text")
        .attr("transform", function (d) {
          const x = (d.x0 + d.x1) / 2 * 180 / Math.PI;
          const y = (d.y0 + d.y1) / 2;
          return `rotate(${x - 90}) translate(${y},0) rotate(${x < 180 ? 0 : 180})`;
        })
        .attr("dy", "0.35em")
        .attr("text-anchor", "middle")
        .style("font-family", "Inter, sans-serif")
        .style("font-weight", "300")
        .style("font-size", d => {
          const arcLength = (d.x1 - d.x0) * (d.y0 + d.y1) / 2;
          return Math.min(14, arcLength / 8) + "px";
        })
        .style("fill", d => {
          const bgColor = color(d);
          const brightness = d3.color(bgColor) ? d3.color(bgColor).displayable() ?
            d3.color(bgColor).rgb().r * 0.299 + d3.color(bgColor).rgb().g * 0.587 + d3.color(bgColor).rgb().b * 0.114 : 128 : 128;
          return brightness > 128 ? "#000000" : "#ffffff";
        })
        .text(d => {
          const arcLength = (d.x1 - d.x0) * (d.y0 + d.y1) / 2;
          const text = d.data.name;
          const maxLength = Math.floor(arcLength / 8);
          return text.length > maxLength ? text.substring(0, maxLength - 3) + "..." : text;
        });

      // Add center text
      svg.append("text")
        .attr("text-anchor", "middle")
        .attr("dy", "0.35em")
        .style("font-family", "Inter, sans-serif")
        .style("font-weight", "300")
        .style("font-size", "14px")
        .style("fill", "#333")
        .text("CLOTHING");

      svg.append("text")
        .attr("text-anchor", "middle")
        .attr("dy", "1.5em")
        .style("font-family", "Inter, sans-serif")
        .style("font-weight", "300")
        .style("font-size", "14px")
        .style("fill", "#333")
        .text("EXPERIENCES");
    }

    // Process responses for sunburst structure
    function processResponsesForSunburst(responses) {
      const categorizeText = (text, categories) => {
        const lowerText = text.toLowerCase();
        for (const [category, keywords] of Object.entries(categories)) {
          if (keywords.some(keyword => lowerText.includes(keyword))) {
            return category;
          }
        }
        return 'Other';
      };

      const physicalCategories = {
        'Comfortable': ['comfortable', 'cozy', 'soft', 'smooth', 'pleasant'],
        'Stylish': ['stylish', 'fashionable', 'trendy', 'chic', 'elegant'],
        'Restrictive': ['tight', 'restrictive', 'constraining', 'stiff'],
        'Textured': ['rough', 'scratchy', 'textured', 'bumpy']
      };

      const emotionalCategories = {
        'Confident': ['confident', 'empowered', 'strong', 'bold'],
        'Happy': ['happy', 'joyful', 'cheerful', 'upbeat', 'good'],
        'Relaxed': ['relaxed', 'calm', 'peaceful', 'comfortable'],
        'Stylish': ['stylish', 'fashionable', 'put-together']
      };

      const itemCategories = {
        'Tops': ['shirt', 'sweater', 'jacket', 'top', 'blouse'],
        'Bottoms': ['pants', 'jeans', 'skirt', 'shorts', 'trousers'],
        'Footwear': ['shoes', 'boots', 'sneakers', 'heels'],
        'Accessories': ['hat', 'scarf', 'jewelry', 'watch', 'bag']
      };

      // Count categories
      const counts = {
        FEEL: { Physical: {}, Emotional: {} },
        MATERIAL: { Great: 0, Okay: 0, 'Not Great': 0 },
        FAVOURITE: { Items: {}, Reasons: {} }
      };

      responses.forEach(response => {
        // Physical feelings
        const physicalCat = categorizeText(response.physical_feeling, physicalCategories);
        counts.FEEL.Physical[physicalCat] = (counts.FEEL.Physical[physicalCat] || 0) + 1;

        // Emotional feelings
        const emotionalCat = categorizeText(response.emotional_feeling, emotionalCategories);
        counts.FEEL.Emotional[emotionalCat] = (counts.FEEL.Emotional[emotionalCat] || 0) + 1;

        // Material quality
        counts.MATERIAL[response.material_quality] = (counts.MATERIAL[response.material_quality] || 0) + 1;

        // Favorite items
        const itemCat = categorizeText(response.favorite_item, itemCategories);
        counts.FAVOURITE.Items[itemCat] = (counts.FAVOURITE.Items[itemCat] || 0) + 1;

        // Favorite reasons (simplified categories)
        const reasonCat = response.favorite_reason.length > 50 ? 'Detailed' : 'Simple';
        counts.FAVOURITE.Reasons[reasonCat] = (counts.FAVOURITE.Reasons[reasonCat] || 0) + 1;
      });

      // Build hierarchy
      return {
        name: "root",
        children: [
          {
            name: "FEEL",
            children: [
              {
                name: "Physical",
                children: Object.entries(counts.FEEL.Physical).map(([key, value]) => ({
                  name: key,
                  value: value
                }))
              },
              {
                name: "Emotional",
                children: Object.entries(counts.FEEL.Emotional).map(([key, value]) => ({
                  name: key,
                  value: value
                }))
              }
            ]
          },
          {
            name: "MATERIAL",
            children: Object.entries(counts.MATERIAL).map(([key, value]) => ({
              name: key,
              value: value
            }))
          },
          {
            name: "FAVOURITE",
            children: [
              {
                name: "Items",
                children: Object.entries(counts.FAVOURITE.Items).map(([key, value]) => ({
                  name: key,
                  value: value
                }))
              },
              {
                name: "Reasons",
                children: Object.entries(counts.FAVOURITE.Reasons).map(([key, value]) => ({
                  name: key,
                  value: value
                }))
              }
            ]
          }
        ]
      };
    }

    // Export to CSV
    function exportToCSV() {
      if (!isLoggedIn) return;

      // This would typically fetch all data and create CSV
      console.log('Export functionality would be implemented here');
    }

    // Show Messages
    function showMessage(message, type) {
      const messageContainer = document.getElementById('messageContainer');
      messageContainer.innerHTML = `<div class="${type === 'success' ? 'success-message' : 'error-message-global'}">${message}</div>`;
      messageContainer.classList.remove('hidden');

      setTimeout(() => {
        messageContainer.classList.add('hidden');
      }, 5000);
    }

    // Listen for service worker messages
    navigator.serviceWorker?.addEventListener('message', (event) => {
      if (event.data.type === 'BACKGROUND_SYNC' && event.data.action === 'syncOfflineData') {
        syncOfflineData();
      }
    });
  </script>
</body>

</html>